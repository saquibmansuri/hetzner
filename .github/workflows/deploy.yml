name: Deploy VM for New Client
env: 
    HCLOUD_TOKEN_PASS: ${{ secrets.HCLOUD_TOKEN }} #--token ${{ secrets.HCLOUD_TOKEN }}

on:
  workflow_dispatch:
    inputs:
      client_name:
        description: 'Name of the new client'
        required: true
      desired_server_location:
        description: 'Desired location of server (e.g., nbg1)' 
        required: true
      server_type:
        description: 'Type of server (e.g., cx11)'
        required: true
      os_image:
        description: 'Operating system image (e.g., ubuntu-20.04)'
        required: true
      environment:
        description: 'Environment name'
        required: true

jobs:
  deploy-vm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install hcloud CLI
        run: |
         sudo apt-get update -y
         sudo apt-get install hcloud-cli -y
         hcloud version
         #curl -L https://github.com/hetznercloud/cli/releases/download/v1.43.0/hcloud-linux-amd64.tar.gz | tar xvz
         #sudo mv hcloud /usr/local/bin/hcloud

      - name: Create Hetzner Cloud VM
        run: |
          HCLOUD_TOKEN_PASS: ${{ secrets.HCLOUD_TOKEN }}
          hcloud server create --name ${{ github.event.inputs.client_name }}-vm \
                                --location ${{ github.event.inputs.desired_server_location }} \
                                --type ${{ github.event.inputs.server_type }} \
                                --image ${{ github.event.inputs.os_image }} \
                                --ssh-key ${{ secrets.TEST_SSH_KEY }} \
                                --label "environment=${{ github.event.inputs.environment }}"